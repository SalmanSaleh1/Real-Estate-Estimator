{% extends "base.html" %}

{% block title %}Real Estate Estimator{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/estimator.css') }}">
{% endblock %}

{% block body %}
  <div class="estimator-wrapper">
    <div class="estimator-container">
      <!-- Title of the estimator tool -->
      <h1 class="estimator-title">Real Estate Estimator Tool</h1>

      <!-- Form for inputting property details -->
      <form action="/estimate" method="POST" class="estimator-form">
        
        <!-- Area dropdown -->
        <div class="form-row">
          <div class="form-column">
            <div class="form-group">
              <label for="area">Area:</label>
              <select name="area" id="area" class="form-control" required>
                <option value="">Select an area</option>
                <option value="منطقة الرياض">منطقة الرياض</option>
                <option value="منطقة مكة المكرمة">منطقة مكة المكرمة</option>
                <option value="منطقة المدينة المنورة">منطقة المدينة المنورة</option>
                <option value="منطقة القصيم">منطقة القصيم</option>
                <option value="المنطقة الشرقية">المنطقة الشرقية</option>
                <option value="منطقة عسير">منطقة عسير</option>
                <option value="منطقة تبوك">منطقة تبوك</option>
                <option value="منطقة حائل">منطقة حائل</option>
                <option value="منطقة الحدود الشمالية">منطقة الحدود الشمالية</option>
                <option value="منطقة جازان">منطقة جازان</option>
                <option value="منطقة نجران">منطقة نجران</option>
                <option value="منطقة الباحة">منطقة الباحة</option>
                <option value="منطقة الجوف">منطقة الجوف</option>
              </select>
            </div>
          </div>

          <!-- City dropdown -->
          <div class="form-column">
            <div class="form-group">
              <label for="city">City:</label>
              <select name="city" id="city" class="form-control" required>
                <option value="">Select a city</option>
              </select>
            </div>
          </div>
        </div>

        <!-- District and Mukatat fields -->
        <div class="form-row">
          <div class="form-column">
            <div class="form-group">
              <label for="district">District:</label>
              <input type="text" name="district" id="district" placeholder="Enter district" class="form-control" required>
            </div>
          </div>

          <div class="form-column">
            <div class="form-group">
              <label for="mukatat">Mukatat:</label>
              <input type="text" name="mukatat" id="mukatat" placeholder="Enter Mukatat" class="form-control" required>
            </div>
          </div>
        </div>

        <!-- Property Classification, Property Type, and Space fields -->
        <div class="form-row">
          <div class="form-column">
            <div class="form-group">
              <label for="property_classification">Property Classification:</label>
              <select name="property_classification" id="property_classification" class="form-control" required>
                <option value="">Select a Classification</option>
                <option value="سكني">سكني</option>
                <option value="تجاري">تجاري</option>
                <option value="زراعي">زراعي</option>
                <option value="صناعي">صناعي</option>
              </select>
            </div>
          </div>

          <div class="form-column">
            <div class="form-group">
              <label for="property_type">Property Type:</label>
              <select name="property_type" id="property_type" class="form-control" required>
                <option value="">Select a Type</option>
                <option value="أرض">أرض</option>
                <option value="أرض زراعية">أرض زراعية</option>
                <option value="شقة">شقة</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Space field -->
        <div class="form-row">
          <div class="form-column">
            <div class="form-group">
              <label for="space">Space (m²):</label>
              <input type="number" name="space" id="space" placeholder="Enter space" class="form-control" required>
            </div>
          </div>
        </div>

        <!-- Submit button -->
        <button type="submit" class="btn btn-primary">Calculate Estimated Value</button>
      </form>

      <!-- Disclaimer -->
      <p class="disclaimer">This estimate is only a prediction and should not be considered the final price. Please consult with a professional for an accurate property valuation.</p>

      <!-- Placeholder for the result -->
      <div id="result" class="result-box"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const areaSelect = document.getElementById('area');
      const citySelect = document.getElementById('city');
      const resultBox = document.getElementById('result');

      // Define city options based on area selection
      const citiesByArea = {
        'منطقة الرياض': ['الافلاج', 'البجاديه', 'الخرج', 'الدرعيه', 'الدلم', 'الدوادمي', 'الرياض', 'الرين', 'الزلفي', 'الغاط', 'المزاحميه', 'حريملاء', 'حوطة بني تميم', 'حوطة سدير', 'رماح', 'شقراء', 'ضرماء', 'عفيف', 'مرات', 'وادي الدواسر'],
        'منطقة مكة المكرمة': ['الخرمه', 'الطائف', 'القنفذه', 'الليث', 'المويه', 'تربه', 'جده', 'رابغ', 'رنيه', 'مكة المكرمة'],
        'منطقة المدينة المنورة': ['الحناكية', 'المدينة المنورة', 'وادي الفرع', 'العلا'],
        'منطقة القصيم': ['البدائع', 'البكيريه', 'الرس', 'المذنب', 'بريده', 'عنيزه'],
        'المنطقة الشرقية': ['ابقيق', 'الاحساء', 'الجبيل', 'الخبر', 'الخفجي', 'الدمام', 'القطيف', 'النعيريه', 'حفر الباطن', 'رأس تنوره'],
        'منطقة عسير': ['ابها', 'احد رفيده', 'بلقرن', 'بيشه', 'تثليت', 'خميس مشيط', 'سراة عبيده', 'ظهران الجنوب', 'محايل عسير'],
        'منطقة تبوك': ['تبوك', 'حقل', 'ضباء', 'تيماء'],
        'منطقة حائل': ['الحائط', 'بقعاء', 'حائل', 'سميراء', 'جبه'],
        'منطقة الحدود الشمالية': ['العويقيله', 'طريف', 'عرعر', 'رفحاء'],
        'منطقة جازان': ['ابو عريش', 'بيش', 'جيزان', 'صامطه', 'الدرب', 'فرسان'],
        'منطقة نجران': ['ثار', 'شروره', 'نجران', 'يدمه'],
        'منطقة الباحة': ['الباحه', 'المخواة', 'بلجرشي', 'العرضيه الجنوبيه', 'النماص'],
        'منطقة الجوف': ['القريات', 'دومة الجندل', 'سكاكا', 'طبرجل']
      };

      // Function to update city options based on selected area
      areaSelect.addEventListener('change', function () {
        const selectedArea = areaSelect.value;

        // Clear previous options
        citySelect.innerHTML = '<option value="">Select a city</option>';

        // Populate city dropdown based on selected area
        if (citiesByArea[selectedArea]) {
          citiesByArea[selectedArea].forEach(function (city) {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            citySelect.appendChild(option);
          });
        }
      });

      // Submit form data to the API and display the result
      document.querySelector('.estimator-form').addEventListener('submit', function (event) {
        event.preventDefault();
        resultBox.style.display = 'block';

        // Collect form data
        const formData = {
          area: document.getElementById('area').value,
          city: document.getElementById('city').value,
          district: document.getElementById('district').value,
          mukatat: document.getElementById('mukatat').value,
          property_classification: document.getElementById('property_classification').value,
          property_type: document.getElementById('property_type').value,
          space: document.getElementById('space').value
        };

        // Send the data to the prediction API
        fetch('/api/estimate_price', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
          // Display the predicted price
          if (data.predicted_price) {
            resultBox.innerHTML = `<h2>Estimated Property Value: ${data.predicted_price.toFixed(2)} SAR</h2>`;
          } else {
            resultBox.innerHTML = '<h2>Error calculating estimated property value</h2>';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          resultBox.innerHTML = '<h2>Failed to calculate estimated property value</h2>';
        });
      });
    });
  </script>
{% endblock %}
